Информация:
14 10 2017 - начало спада.

Формат баннера придумать.
А так вообще, переходим к продайка
--------------------------------------------------------
Инпут календаря подшаманить для мобилки и внедрить.



В просмотр активности можно добавить результат

SELECT users.phone, users.email, main.id, cities.city_name, regions.region_name, users.upcount FROM `users` 
INNER JOIN main ON users.phone = main.phone
LEFT JOIN cities ON main.city = cities.id
LEFT JOIN regions ON main.region = regions.id
WHERE upcount < 100 
AND main.is_deleted != 1  
GROUP BY users.phone
ORDER BY upcount  Asc


Показывать кнопку только тогда, когда юзерскрипт включен.

Юзерскрипт для оплаты по телефонам
возможно, будем списывать по связи - время платежа, запись в pay_transaction

Итак, юзерскрипт, так как HTTP нотайсы похоже ненадежны

Запрос деталей операции
https://money.yandex.ru/ajax/history/details?isBusinessAccount=false&login=lamzin.a.m.d&payment-item-id=839146038
https://money.yandex.ru/ajax/history/details?isBusinessAccount=false&login=lamzin.a.m.d&payment-item-id=837365418
в ответе прежде всего интересует
quickpayDepositTarget - это наш pay_transaction_id

Логика:
Скрипт запрашивает у нас дату последнего подтвержденного платежа.
 (если такого нет, возвращается дата первой транзакции или дата из конфига)
Получив дату, он мотает историю операций, пока не дойдет до неё или до более ранней.
"Мотаем" такими запросами:
https://money.yandex.ru/ajax/history/partly?ncrnd=2335&history_shortcut=history_all&search=&start-record=0&record-count=20

item-id нас интересует в ответе (это payment-item-id для запроса подробностей.)
а также type == 4 (поплнение)

Увидав type == 4  запрашивает детали.
В деталях первым делом смотрит на success
 и отправляет нам либо quickpayDepositTarget
 либо полученный из comment номер телефона, с которого происходило полполнение.
также отправляет сумму (sum)  и date (из ответа про подробности.).

Это более менее ясно.

Контроль показа платежной формы.

Как-то определяем, что юзерскрипт пашет как папакарло. 
Юзерскрипт раз в минуту отправляет запрос ЯТут.
Если последнее время такого запроса менее 5 минут, 
		Или запрос "ЯУёЧерез5Мин" свеженький (ему менее 5 минут)
		значит считаем, что он не работает.



Если определили, показываем форму.

Если не пашет, если время по Москве нерабочее, пишет, что прием платежей обычно доступен в рабочее время и НИИепЕТ
Если рабочее, пишем, что у нас карамболь, мы уже с жопой в мыле работаем над проблемой.



Просмотр биллинга по пользователям
  добавить в это хозяйство кнопки "дальше - больше"

То есть я должен ввести номер телефона и видеть все по номеру, приход, расход.
 в таблицу операций добавить 


Начислять на баланс пользователя возможность поднятий при совпадении хеша. 	*

При включенной оплате надпись "В октябре вы можете" меняем на "Вы можете"

Добавить при входе на страницу проверку - дергаем фаст, и ждем что фаст		*
дернет нас в течении 30 секунд. Если дернул, то ок, показываем форму.


Логинимся в рк															*
Выносим все пароли т п в конфиг на локале								*
Копируем секцию ркасса в конфиг на тесте								*
Кнопку оплатить через мобилу допиливаем в получение запроса для 		*
рк дж скрипта.
 
Логируем в базу нотификации от рк. в pay_transaction добавялем ссылку 	*
на ркассу. Для нее соотв. таблица.

страницы для ркуспех ркнеуспех - думаю редирект на поднятия к месту		*

 


юзерскрипт оставляем только для кнопки оплатить мобильным и на дальнее будущее





Кнопки выбора оплат	*
Поднять 1 раз - 60 Р
Поднять 5 раз - 200 Р
Поднять 31 раз - 700 Р







Пока считаем некритичным.
Пользователь удаляет объявление, подает новое.
Практически, поднимает его.

Чёрт с ним, оплата.
Итак, что мне нужно.

При этом коде апоказываем форму ввода, если платежи в принципе включены.
/cabinet?status=3

И её же показываем вместо надписи Вы сможете поднять ваше объявлене в октябре если платежи включены.

И все протестировать, биллинг - шмиллинг и т. п.


Итак, вроде родили.

https://e-kontur.ru/Ip/PersonalDataStep

Будем тут пытаться оформить

После того как запилим.
ОКВЭД 73.11, 63.11.1, 62.01, 62.09

73.12 
63.12.1
а вообще-то ждём письма, может ответят.

https://money.yandex.ru/quickpay/form?from=iget&_openstat=iget%3Bshop%3Bicon

Ограничиваемся Яндексом. И всё.



Мудрить не будем, себе дороже.
Штраф  40 000 + отжать сайт если мудрить.
28 000 + 12 000 === 40 000 если делать всё по закону.
Итого - регимся.


Яндекс забивает на мобилы при подтверждении.
Попробовать перевести с мобилы, чтобы посмотреть, что там на почте.

Поднятия теперь конкретно учитывать,  пользователь, время поднятия, "сумма" списания.
Начисления поднятий учитывать, пользователь, время начисления, "сумма" зачисления (кол-во) поднятий, реальная сумма.
То есть, здравствуйте, вас кажется некоторые называют биллинг?




При попытке поднять объявление показываем страницу 
"Время бесплатных поднятий на gazel.me закончилось"

Перед "апиратором" подергать форму ЯД, может там таки есть фидбеки и колбеки.
Для банковской карты и ЯД есть
Для мобилок бота написать вполне реально.


Далее, если доступен оператор показываем кнопку "Оплатить возможность поднятия"
 если недоступен, сообщение Оплатить возможность поднятия возможно с
понедельника по пятницу с 09 00 до 13 00 и с 14 00 до 18 00 по московскому времени.

При переходе по "Оплатить возможность поднятия"

Чтобы не ждать в следующий раз оператора, вы можете оплатить сразу пакет поднятий.

 Одно поднятие - 30 рублей
 Пять поднятий - 100 рублей
 Десять поднятий - 150 рублей
 50 поднятий     - 500 рублей
 100 поднятий    - 800 рублей
 
 
 Далее, выбор способа оплаты
 
 Оплатить Яндекс деньгами
 Оплатить переводом на номер Мегафон
 Оплатить переводом на номер МТС
 Оплатить переводом на номер Beeline
 
 при переходе на вариант видит сообщение
 Переведите N рублей на номер [кошелька Яндекс Денег] 77777777
 Как только ваш платеж поступит на счет, у вас появится возможность N раз поднять объявление на gazel.me
 
 либо сообщение 
 
 Ждем оператора 
 Внимание! Даже если вы совершали платеж ранее и вам известны реквизиты оплаты, не совершайте оплату 
 прежде чем оператор не освободится!
 
 если оператор в это время контролирует такую же сумму на такой же тип оплаты.
 
 Если связь с оператором была, когда клиент проходил предыдущие стадии и пропала во время того, как он находится на странице
 "Переведите N рублей..." и он находился на странице не более полу-часа
 
 Ему зачисляется запрошенное кол-во поднятий и выводится сообщение
 "Теперь у вас есть возможность N раз поднять объявление на gazel.me"
 "Мы пока не дождались платежа. Надеемся на вашу порядочность."
 Этот факт фиксируется в специальной таблице.
 Если кто-то зачастит, для его номера такую возможность режем.
 
 В админке, 
 с любой странице админке отправляется нотайс если появился новый человек на странице 
 "Переведите N рублей..."
 
 страница оператора
 
 Список ожидающих.
 Способ в виде иконки. Сумма.
 Тел. Имя.  Время в которое он зашел на страницу.
 Отсортированы по времени от меньшего к большему.
 С такими же суммами и способами ниже и имеют бледный вид.
 
 Действия оператора.
 Он смотрит на яркие и ждет, пока изменится баланс на счете.
 
 Когда баланс меняется на счете на сумму, равную ожидаемой, кликает на яркую кнопку
 "Вы уверены, что хотите одобрить?"
 
 Когда баланс меняется на счете на сумму меньше чем ????
 
 В кнопку внедрить калькулятор - вводим пришедшую сумму, она автоматически устанавливает кол-во поднятий.
 Расчет ведется по предыдущей ставке. то есть если пришло 499, то по 15 руб за поднятие - 34 поднятия в пользу клиента.
 После ввода значения в калькулятор пользователь видит соотв. сообщение. на странице и на странице поднятия объявления.

Страница просмотра баланса клиента
По номеру телефона клиента выводить историю зачислений и списаний с точным временем.


Запретить подавать объявления с известных уже номеров.

 время создания (публикации) объявления.
 если от него прошло 30 дней, можно еще одно публиковать.
 

Запретить подавать объявление, если есть с того же номера опубликованное менее чем 30 дней назад.




~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~




все таки заманчиво насчет карты.

ВТБ - фичи
23 50 success sms
23 51 отправил подтверждение
23 41 появился в истории операций как неподтвержденный.

Никакой информации по отправителю платежа не видно.

платеж упал на телефон 23 50 00 01 - все еще гнепонятный статус.


Главный вопрос, если кто-то решит меня запутать и сделать так:

Один заходит и заказывает платеж 100 рублей на МТС и ждет

Второй в это время не заходя (или не дождавшись оператора) кидает 100 на МТС.

И что делать, если они начнут скопом кидать бабло, а потом кричать, что каждый из них заплатил?
Нужен контроль, кто конкретно платил.

Я пополняю первому.
Второй подает в суд, или тем или иным способом меня находит и качает права.

Как я могу быть увереным, что все так и было? (И надо ли заморачиваться?)


Запретить подавать объявления с известных уже номеров.
Запретить подавать объявление, если есть с того же номера опубликованное менее чем 30 дней назад.

Поднятия теперь конкретно учитывать,  пользователь, время поднятия, "сумма" списания.
Начисления поднятий учитывать, пользователь, время начисления, "сумма" зачисления (кол-во) поднятий, реальная сумма.
То есть, здраствуйте, вас кажется некоторые называют биллинг?

При попытке поднять объявление показываем страницу 
"Время бесплатных поднятий на gazel.me закончилось"

Далее, если доступен оператор показываем кнопку "Оплатить возможность поднятия"
 если недоступен, сообщение Оплатить возможность поднятия возможно с
понедельника по пятницу с 09 00 до 13 00 и с 14 00 до 18 00 по московскому времени.

При переходе по "Оплатить возможность поднятия"

Чтобы не ждать в следующий раз оператора, вы можете оплатить сразу пакет поднятий.

 Одно поднятие - 30 рублей
 Пять поднятий - 100 рублей
 Десять поднятий - 150 рублей
 50 поднятий     - 500 рублей
 100 поднятий    - 800 рублей
 
 
 Далее, выбор способа оплаты
 
 Оплатить Яндекс деньгами
 Оплатить переводом на номер Мегафон
 Оплатить переводом на номер МТС
 Оплатить переводом на номер Beeline
 
 при переходе на вариант видит сообщение
 Переведите N рублей на номер [кошелька Яндекс Денег] 77777777
 Как только ваш платеж поступит на счет, у вас появится возможность N раз поднять объявление на gazel.me
 
 либо сообщение 
 
 Ждем оператора 
 Внимание! Даже если вы совершали платеж ранее и вам известны реквизиты оплаты, не совершайте оплату 
 прежде чем оператор не освободится!
 
 если оператор в это время контролирует такую же сумму на такой же тип оплаты.
 
 Если связь с оператором была, когда клиент проходил предыдущие стадии и пропала во время того, как он находится на странице
 "Переведите N рублей..." и он находился на странице не более полу-часа
 
 Ему зачисляется запрошенное кол-во поднятий и выводится сообщение
 "Теперь у вас есть возможность N раз поднять объявление на gazel.me"
 "Мы пока не дождались платежа. Надеемся на вашу порядочность."
 Этот факт фиксируется в специальной таблице.
 Если кто-то зачастит, для его номера такую возможность режем.
 
 В админке, 
 с любой странице админке отправляется нотайс если появился новый человек на странице 
 "Переведите N рублей..."
 
 страница оператора
 
 Список ожидающих.
 Способ в виде иконки. Сумма.
 Тел. Имя.  Время в которое он зашел на страницу.
 Отсортированы по времени от меньшего к большему.
 С такими же суммами и способами ниже и имеют бледный вид.
 
 Действия оператора.
 Он смотрит на яркие и ждет, пока изменится баланс на счете.
 
 Когда баланс меняется на счете на сумму, равную ожидаемой, кликает на яркую кнопку
 "Вы уверены, что хотите одобрить?"
 
 Когда баланс меняется на счете на сумму меньше чем ????
 
 В кнопку внедрить калькулятор - вводим пришедшую сумму, она автоматически устанавливает кол-во поднятий.
 Расчет ведется по предыдущей ставке. то есть если пришло 499, то по 15 руб за поднятие - 34 поднятия в пользу клиента.
 После ввода значения в калькулятор пользователь видит соотв. сообщение. на странице и на странице поднятия объявления.

Страница просмотра баланса клиента
По номеру телефона клиента выводить историю зачислений и списаний с точным временем.






































------------------
Исходя из того что есть.
При подаче объявления смс код обязателен.
Поэтому для каждого записи в main сразу генерим код и сразу же его отправляем в смс.
Если такой код введен верно, то в users пишем verify = 1 для данного тел. номера.

При поднятии если не верифи - то код генерим туда же, где и при подаче, сравниваем, прочее соответственно.

В обоих случаях коды генерим в отдельной табличке, main_id - уникальный ключ, при дублировании обновляем.
При успешной авторизации - удаляем запись.

Если подает авторизованый, то смс не надо.

Какие поля нужны в main в связи с внедрением смс?
 не забыть про интервал две минуты между запросами.








Верстка.

Помнить, что все страницы должны быть рабочими с экрана смартфона, сейчас это так, надо чтобы и дальше было так.

Сохранить себе на диск страницу поднятия объявлений, страницу при сохранении назвать как-нибудь очень коротко, например 1.html

(Чтобы увидеть страницу поднятия объявлений, подать объявление на сайте gazel.me указав пароль и мыло, после чего авторизоваться и нажать
на ссылку (кнопку) "поднять").


Это будет страничка 01.html

Добавить на эту страничку заметное сообщение, "У вас осталось 100 бесплатных поднятий объявлений"


Создать новую страничку (02)

У пользователя 0 поднятий, формы для ввода капчи нет

он видит сообщение: 

Поднятие одного объявления стоит 1 рубль

Приобрести можно от 10 до 300 поднятий.


Кнопка Продолжить?

Создать новую страничку (03)

Видим логотипы большой тройки операторов (МТС, Билайн, Мегафон), также логотипы яндекс денег и вебмани

Перед добавлением проверь, позволяют ли Билайн и Мегафон переводить со счета на счет и выводить со счета на карту или ещё как.
МТС проверен.


Для каждой ссылки добавляем страницу 04_система, то есть например (04_mts.html, 04_beeline.html).

На этих страницах видим краткую инструкцию, что и куда надо отправить (например смс номер сумма на номер такой-то для МТС).


Добавить ссылку (ссылки) на страницу (страницы) соотв. сайта, где описаны условия перевод со счета на счет.

Например для МТС можно две ссылки: на страницу с описанием  этой услуги и на pdf документ с подробным описанием (есть у них на сайте).


Для яндекс денег и вебманей просто текущую коммиссию за перевод от абонента на номер абонента, в верстке можно от балды цифру указать.



Также хорошо бы сакцентировать внимание пользователя, что выгоднее один раз оплатить 100 рублей чем 100 раз по 1-му
потому что за перевод  берется коммиссия. В принципе вещь очевидная, но не помешает, но надо ненавязчиво. 
Короче если сложно, с этим моментом не заморачивайся.
=======
License
Соц сети.


добавить проверку на наличие сайта в тексте																		*

Вариант с флагом со стороны js в контроллерах обрабатывается ошибочно.											*
Проверка должна быть не только для текста объявления, но еще для заголовка и телефона.							*
Алгоритм проверки на телефон в тексте.																			*
 разбить по словам
 из каждого удалить все не цифры
 если более 4 цифр в слове - нужно модерировать вручную.
 если подрят идут более двух слов состоящих из цифр - нужно модерировать вручную.

JS проверяет этим алгоритмом, если найдено, отправляет флаг need moderate										*
ЗЗЗ PHP при подаче объявления если видит флаг nm и он равен 1 - сразу помечает как модерируемое вручную 		*
 (как сейчас) иначе - запускает алгоритм и см ЗЗЗ.
 
 насчет редактирования - не забыть																				*
 
Как пометить объявление как автоматически модерируемое.															*
 Добавить поле в базу automoderate по умолчанию 0.
 Если объявление прошло проверку автоматом - ставим его в 1.
 
 Дать объявление с телефоном в тексте - am должно быть равно 0													*
 Дать объявление без телефона в тексте - am должно быть равно 1													*
 
 
Добавить админ - страницу, на которой показываются опубликованые объявления с automoderate = 1.					*
Кнопки Удалить, Публиковать - последняя снимает automoderate - по сути копия страницы модерации 
	так как тоже ставит is_moderate = 1.

Страница модерации - добавить снятие флага automoderate при публикации.											*

Скрипт js запрашивает воркер. Воркер берет автомодерированые лежащие более 15 минут и ставит их модерироваными. *
 Флаг is_moderate при этом изменяется, флаг automoderate - нет.
 Проверить, как там себя на сервере ведет поле created, если неправильно, пусть оно ставится скриптом.


В модераторской показывать автоматику синим																		*

Добавить пункт в меню																							*

При админлогине редиректить на private/autoadv																	*

Отключение автомодерации из конфига																				*




Баги
Нельзя подать объявление без картинки. На сервере - работает вроде.... проверить на локалке для термобудки     *



Пишем тест платных объявлений.

На той странице, что есть сейчас для поднятия объявлений

Пользователь видит сообщение, "У вас осталось 100 бесплатных поднятий объявлений"

Когда видит 0, видит сообщение 

Поднятие одного объявления стоит 1 рубль

Приобрести можно от 10 до 300 поднятий.

Кнопка Продолжить?     /считаем количество нажатий

Видим логотипы большой тройки операторов

Выбираем нужную.     //считаем количество нажатий на логотипы

Видим инструкцию, что и куда надо отправить (например смс номер сумма на номер такой-то для МТС)



next stop


http://ipgeobase.ru/cgi-bin/AdvSearch.cgi?country=RU&city=&region=&district=&adv_srch_sbmt=%C8%F1%EA%E0%F2%FC&action_type=adv_search

217.66.156.16 Спб
78.109.16.152 - 78.109.16.159 - Москва
91.235.169.0 - 91.235.169.255 - Нижний
109.70.184.0 - 109.70.187.255 - Махачкала
194.105.197.0 - 194.105.197.127 - Выборг
176.115.136.0 - 176.115.143.255 - Кизляр

надо подумать вообще
заходит чел, если страница главная и ua+ip не перенаправлялся в течении часа, и удалость определить регион - редирект на регион

завтра начну потихоньку пилить локации



Релиз в октябре
 

При релизе 
не забыть удалить тестовый ip из index.php

Выполнить на продакте                     *
 geoip.sql


тщательно проверить, что там с датами.

Искать в истории по #geoip


router.php
index.php

lib/functions.php							*
lib/geoip.php								*
SxG*/*										*
lib/request_patcher							*




Ограничить поднятия, пока просто по числу в месяц.
поле в users? 
В начале месяца ставим в него 500.
Как это сделать при отсутствии крона.
Таблица ymup из одного поля.
Ищем в ней число Ym (201709 для сентября)
Если оно есть, выходим.
Если нет, делаем "UPDATE users SET upcount = 500"
INSERT INTO ymup (c) VALUES('201709')
В перспективе
на клиенте ставим ls с номером месяца, пока месяц ему равен, никого не дергать.

При показе страницы выводим "В сентябре вы можете поднять ваши объявления ещё * раз".
если *  <= 0 выводим "Вы cможете поднять ваше объявление в октябре"
По факту поднятия декрементим.
Следим, чтобы при поднятии суперадмином не декрементилось.




Сервисы для проверки оператоорв
http://regionoperator.ru
